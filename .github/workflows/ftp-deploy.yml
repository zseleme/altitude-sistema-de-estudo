name: Deploy FTP AutomÃ¡tico

on:
  push:
    branches:
      - main
      - develop

jobs:
  deploy:
    name: Deploy via FTP
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Definir pasta de destino
        id: target
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "folder=/www/altitude.zaiden.eng.br" >> $GITHUB_OUTPUT
            echo "environment=ProduÃ§Ã£o" >> $GITHUB_OUTPUT
            echo "color=green" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            echo "folder=/www/altitude-dev.zaiden.eng.br" >> $GITHUB_OUTPUT
            echo "environment=Desenvolvimento" >> $GITHUB_OUTPUT
            echo "color=yellow" >> $GITHUB_OUTPUT
          fi

      - name: Exibir informaÃ§Ãµes do deploy
        run: |
          echo "ðŸš€ ================================"
          echo "ðŸš€ Deploy para ${{ steps.target.outputs.environment }}"
          echo "ðŸš€ ================================"
          echo "ðŸ“ Pasta destino: ${{ steps.target.outputs.folder }}"
          echo "ðŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ðŸ“ Commit: ${{ github.sha }}"
          echo "ðŸ‘¤ Autor: ${{ github.actor }}"

      - name: Gerar informaÃ§Ãµes de deploy
        run: |
          # Criar version.json na raiz (serÃ¡ enviado ao servidor)
          cat > version.json <<EOF
          {
            "version": "$(date +%Y.%m.%d-%H%M%S)",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "deployed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "deployed_by": "${{ github.actor }}",
            "environment": "${{ steps.target.outputs.environment }}"
          }
          EOF

          # Criar pasta deploy-info para logs (nÃ£o serÃ¡ enviada)
          mkdir -p deploy-info
          cp version.json deploy-info/version.json

          cat > deploy-info/LAST_DEPLOY.txt <<EOF
          ====================================
          ÃšLTIMO DEPLOY
          ====================================
          Ambiente: ${{ steps.target.outputs.environment }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Data: $(date)
          Por: ${{ github.actor }}
          ====================================
          EOF

          echo "âœ… Arquivo de versÃ£o criado"
          cat version.json

      - name: Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          server-dir: ${{ steps.target.outputs.folder }}/
          dangerous-clean-slate: false
          dry-run: false
          log-level: verbose
          state-name: .ftp-deploy-sync-state-${{ github.ref_name }}.json
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/vendor/**
            **/.env
            **/config/estudos.db
            **/config/database.php
            **/config/openai.php
            **/.github/**
            **/tests/**
            **/*.md
            **/.gitignore
            **/deploy-info/**

      - name: Resumo do Deploy
        if: success()
        run: |
          echo "âœ… ================================"
          echo "âœ… Deploy concluÃ­do com sucesso!"
          echo "âœ… ================================"
          echo ""
          echo "ðŸ“Š Detalhes:"
          echo "  â€¢ Ambiente: ${{ steps.target.outputs.environment }}"
          echo "  â€¢ Pasta: ${{ steps.target.outputs.folder }}"
          echo "  â€¢ Branch: ${{ github.ref_name }}"
          echo "  â€¢ Commit: $(git log -1 --pretty=format:'%h - %s')"
          echo "  â€¢ Arquivos enviados: âœ“"
          echo ""
          echo "ðŸŒ Acesse:"
          if [ "${{ steps.target.outputs.environment }}" == "ProduÃ§Ã£o" ]; then
            echo "  â€¢ https://altitude.zaiden.eng.br/"
          else
            echo "  â€¢ https://altitude.dev.zaiden.eng.br/"
          fi

      - name: Notificar erro
        if: failure()
        run: |
          echo "âŒ ================================"
          echo "âŒ Deploy falhou!"
          echo "âŒ ================================"
          echo ""
          echo "ðŸ” Verifique os logs acima para detalhes do erro."
          echo ""
          echo "PossÃ­veis causas:"
          echo "  â€¢ Credenciais FTP incorretas"
          echo "  â€¢ Servidor FTP offline"
          echo "  â€¢ PermissÃµes de pasta incorretas"
          echo "  â€¢ Erro na geraÃ§Ã£o do version.json"
