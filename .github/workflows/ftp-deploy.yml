name: Deploy FTP Autom√°tico

on:
  push:
    branches:
      - main
      - develop

jobs:
  # Primeiro job: validar sintaxe PHP
  validate:
    name: Validar PHP
    runs-on: ubuntu-latest
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Validar sintaxe PHP
        run: |
          echo "üîç Validando arquivos PHP..."
          errors=0
          while IFS= read -r file; do
            if ! php -l "$file" > /dev/null 2>&1; then
              echo "‚ùå Erro em: $file"
              php -l "$file"
              errors=$((errors + 1))
            fi
          done < <(find . -name "*.php" -not -path "./vendor/*" -not -path "./node_modules/*")

          if [ $errors -gt 0 ]; then
            echo "‚ùå Encontrados $errors arquivos com erros de sintaxe!"
            exit 1
          fi
          echo "‚úÖ Todos os arquivos PHP est√£o v√°lidos!"

  # Segundo job: deploy para m√∫ltiplos servidores FTP em paralelo
  deploy:
    name: Deploy ${{ matrix.server_name }}
    needs: validate
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # Servidor 1
          - server_id: "1"
            server_name: "Servidor Principal"
            enabled: true
          # Servidor 2 (adicione mais servidores aqui)
          - server_id: "2"
            server_name: "Servidor Backup"
            enabled: true
          # Servidor 3
          - server_id: "3"
            server_name: "Servidor Terci√°rio"
            enabled: true

    steps:
      - name: Verificar se servidor est√° configurado
        id: check
        run: |
          # Verificar se as credenciais existem para este servidor
          case "${{ matrix.server_id }}" in
            "1")
              if [ -n "${{ secrets.FTP_SERVER_1 }}" ] && [ -n "${{ secrets.FTP_USERNAME_1 }}" ] && [ -n "${{ secrets.FTP_PASSWORD_1 }}" ]; then
                echo "configured=true" >> $GITHUB_OUTPUT
              else
                echo "configured=false" >> $GITHUB_OUTPUT
                echo "‚ö†Ô∏è Servidor ${{ matrix.server_name }} n√£o configurado, pulando..."
              fi
              ;;
            "2")
              if [ -n "${{ secrets.FTP_SERVER_2 }}" ] && [ -n "${{ secrets.FTP_USERNAME_2 }}" ] && [ -n "${{ secrets.FTP_PASSWORD_2 }}" ]; then
                echo "configured=true" >> $GITHUB_OUTPUT
              else
                echo "configured=false" >> $GITHUB_OUTPUT
                echo "‚ö†Ô∏è Servidor ${{ matrix.server_name }} n√£o configurado, pulando..."
              fi
              ;;
            "3")
              if [ -n "${{ secrets.FTP_SERVER_3 }}" ] && [ -n "${{ secrets.FTP_USERNAME_3 }}" ] && [ -n "${{ secrets.FTP_PASSWORD_3 }}" ]; then
                echo "configured=true" >> $GITHUB_OUTPUT
              else
                echo "configured=false" >> $GITHUB_OUTPUT
                echo "‚ö†Ô∏è Servidor ${{ matrix.server_name }} n√£o configurado, pulando..."
              fi
              ;;
          esac

      - name: Checkout c√≥digo
        if: steps.check.outputs.configured == 'true'
        uses: actions/checkout@v4

      - name: Definir configura√ß√£o do servidor
        if: steps.check.outputs.configured == 'true'
        id: config
        run: |
          # Definir vari√°veis com base no servidor e branch
          SERVER_ID="${{ matrix.server_id }}"
          BRANCH="${{ github.ref_name }}"

          # Definir ambiente e cor
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "environment=Produ√ß√£o" >> $GITHUB_OUTPUT
            echo "color=green" >> $GITHUB_OUTPUT
            echo "is_production=true" >> $GITHUB_OUTPUT
          else
            echo "environment=Desenvolvimento" >> $GITHUB_OUTPUT
            echo "color=yellow" >> $GITHUB_OUTPUT
            echo "is_production=false" >> $GITHUB_OUTPUT
          fi

          # Obter path do GitHub Variables baseado no servidor e branch
          # Formato esperado das vari√°veis:
          # FTP_PATH_1_MAIN, FTP_PATH_1_DEV, FTP_URL_1_MAIN, FTP_URL_1_DEV
          # FTP_PATH_2_MAIN, FTP_PATH_2_DEV, FTP_URL_2_MAIN, FTP_URL_2_DEV

          if [ "$BRANCH" == "main" ]; then
            case "$SERVER_ID" in
              "1")
                echo "folder=${{ vars.FTP_PATH_1_MAIN }}" >> $GITHUB_OUTPUT
                echo "url=${{ vars.FTP_URL_1_MAIN }}" >> $GITHUB_OUTPUT
                ;;
              "2")
                echo "folder=${{ vars.FTP_PATH_2_MAIN }}" >> $GITHUB_OUTPUT
                echo "url=${{ vars.FTP_URL_2_MAIN }}" >> $GITHUB_OUTPUT
                ;;
              "3")
                echo "folder=${{ vars.FTP_PATH_3_MAIN }}" >> $GITHUB_OUTPUT
                echo "url=${{ vars.FTP_URL_3_MAIN }}" >> $GITHUB_OUTPUT
                ;;
            esac
          else
            case "$SERVER_ID" in
              "1")
                echo "folder=${{ vars.FTP_PATH_1_DEV }}" >> $GITHUB_OUTPUT
                echo "url=${{ vars.FTP_URL_1_DEV }}" >> $GITHUB_OUTPUT
                ;;
              "2")
                echo "folder=${{ vars.FTP_PATH_2_DEV }}" >> $GITHUB_OUTPUT
                echo "url=${{ vars.FTP_URL_2_DEV }}" >> $GITHUB_OUTPUT
                ;;
              "3")
                echo "folder=${{ vars.FTP_PATH_3_DEV }}" >> $GITHUB_OUTPUT
                echo "url=${{ vars.FTP_URL_3_DEV }}" >> $GITHUB_OUTPUT
                ;;
            esac
          fi

      - name: Verificar se path est√° configurado
        if: steps.check.outputs.configured == 'true'
        id: check_path
        run: |
          if [ -z "${{ steps.config.outputs.folder }}" ]; then
            echo "has_path=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Path n√£o configurado para ${{ matrix.server_name }} no branch ${{ github.ref_name }}"
          else
            echo "has_path=true" >> $GITHUB_OUTPUT
          fi

      - name: Exibir informa√ß√µes do deploy
        if: steps.check.outputs.configured == 'true' && steps.check_path.outputs.has_path == 'true'
        run: |
          echo "üöÄ ================================"
          echo "üöÄ Deploy para ${{ steps.config.outputs.environment }}"
          echo "üöÄ Servidor: ${{ matrix.server_name }}"
          echo "üöÄ ================================"
          echo "üìÅ Pasta destino: ${{ steps.config.outputs.folder }}"
          echo "üåø Branch: ${{ github.ref_name }}"
          echo "üìù Commit: ${{ github.sha }}"
          echo "üë§ Autor: ${{ github.actor }}"

      - name: Gerar informa√ß√µes de deploy
        if: steps.check.outputs.configured == 'true' && steps.check_path.outputs.has_path == 'true'
        run: |
          cat > version.json <<EOF
          {
            "version": "$(date +%Y.%m.%d-%H%M%S)",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "deployed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "deployed_by": "${{ github.actor }}",
            "environment": "${{ steps.config.outputs.environment }}",
            "server": "${{ matrix.server_name }}"
          }
          EOF

          echo "‚úÖ Arquivo de vers√£o criado"
          cat version.json

      - name: Deploy via FTP - Servidor 1
        if: steps.check.outputs.configured == 'true' && steps.check_path.outputs.has_path == 'true' && matrix.server_id == '1'
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER_1 }}
          username: ${{ secrets.FTP_USERNAME_1 }}
          password: ${{ secrets.FTP_PASSWORD_1 }}
          server-dir: ${{ steps.config.outputs.folder }}/
          dangerous-clean-slate: false
          dry-run: false
          log-level: verbose
          state-name: .ftp-deploy-sync-state-${{ github.ref_name }}-server1.json
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/vendor/**
            **/.env
            **/config/estudos.db
            **/config/database.php
            **/config/openai.php
            **/config/encryption.key
            **/.github/**
            **/tests/**
            **/*.md
            **/.gitignore
            **/deploy-info/**

      - name: Deploy via FTP - Servidor 2
        if: steps.check.outputs.configured == 'true' && steps.check_path.outputs.has_path == 'true' && matrix.server_id == '2'
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER_2 }}
          username: ${{ secrets.FTP_USERNAME_2 }}
          password: ${{ secrets.FTP_PASSWORD_2 }}
          server-dir: ${{ steps.config.outputs.folder }}/
          dangerous-clean-slate: false
          dry-run: false
          log-level: verbose
          state-name: .ftp-deploy-sync-state-${{ github.ref_name }}-server2.json
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/vendor/**
            **/.env
            **/config/estudos.db
            **/config/database.php
            **/config/openai.php
            **/config/encryption.key
            **/.github/**
            **/tests/**
            **/*.md
            **/.gitignore
            **/deploy-info/**

      - name: Deploy via FTP - Servidor 3
        if: steps.check.outputs.configured == 'true' && steps.check_path.outputs.has_path == 'true' && matrix.server_id == '3'
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER_3 }}
          username: ${{ secrets.FTP_USERNAME_3 }}
          password: ${{ secrets.FTP_PASSWORD_3 }}
          server-dir: ${{ steps.config.outputs.folder }}/
          dangerous-clean-slate: false
          dry-run: false
          log-level: verbose
          state-name: .ftp-deploy-sync-state-${{ github.ref_name }}-server3.json
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/vendor/**
            **/.env
            **/config/estudos.db
            **/config/database.php
            **/config/openai.php
            **/config/encryption.key
            **/.github/**
            **/tests/**
            **/*.md
            **/.gitignore
            **/deploy-info/**

      - name: Resumo do Deploy
        if: steps.check.outputs.configured == 'true' && steps.check_path.outputs.has_path == 'true' && success()
        run: |
          echo "‚úÖ ================================"
          echo "‚úÖ Deploy conclu√≠do com sucesso!"
          echo "‚úÖ ================================"
          echo ""
          echo "üìä Detalhes:"
          echo "  ‚Ä¢ Servidor: ${{ matrix.server_name }}"
          echo "  ‚Ä¢ Ambiente: ${{ steps.config.outputs.environment }}"
          echo "  ‚Ä¢ Pasta: ${{ steps.config.outputs.folder }}"
          echo "  ‚Ä¢ Branch: ${{ github.ref_name }}"
          echo "  ‚Ä¢ Commit: $(git log -1 --pretty=format:'%h - %s')"
          echo ""
          if [ -n "${{ steps.config.outputs.url }}" ]; then
            echo "üåê Acesse: ${{ steps.config.outputs.url }}"
          fi

      - name: Notificar erro
        if: steps.check.outputs.configured == 'true' && steps.check_path.outputs.has_path == 'true' && failure()
        run: |
          echo "‚ùå ================================"
          echo "‚ùå Deploy falhou para ${{ matrix.server_name }}!"
          echo "‚ùå ================================"
          echo ""
          echo "üîç Verifique os logs acima para detalhes do erro."
          echo ""
          echo "Poss√≠veis causas:"
          echo "  ‚Ä¢ Credenciais FTP incorretas"
          echo "  ‚Ä¢ Servidor FTP offline"
          echo "  ‚Ä¢ Permiss√µes de pasta incorretas"
