name: Deploy FTP Autom√°tico

on:
  push:
    branches:
      - main
      - develop

jobs:
  deploy:
    name: Deploy via FTP
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: pdo, pdo_sqlite, pdo_pgsql, mbstring

      - name: Validar sintaxe PHP
        run: |
          echo "üîç Validando sintaxe PHP antes do deploy..."
          ERROR_COUNT=0
          FILE_COUNT=0

          while IFS= read -r file; do
            FILE_COUNT=$((FILE_COUNT + 1))
            if ! php -l "$file" > /dev/null 2>&1; then
              echo "‚ùå Erro em: $file"
              php -l "$file"
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
          done < <(find . -name "*.php" -not -path "./vendor/*" -not -path "./node_modules/*")

          echo ""
          echo "üìä Resumo da valida√ß√£o:"
          echo "  ‚Ä¢ Arquivos verificados: $FILE_COUNT"
          echo "  ‚Ä¢ Erros encontrados: $ERROR_COUNT"

          if [ $ERROR_COUNT -gt 0 ]; then
            echo "‚ùå Deploy cancelado devido a erros de sintaxe!"
            exit 1
          fi
          echo "‚úÖ Sintaxe PHP OK"

      - name: Verificar arquivos cr√≠ticos
        run: |
          echo "üîç Verificando arquivos cr√≠ticos do sistema..."
          MISSING_FILES=()

          # Arquivos essenciais
          CRITICAL_FILES=(
            "includes/auth.php"
            "includes/auto_install.php"
            "includes/ai_helper.php"
            "includes/layout.php"
            "includes/version.php"
            "config/database.php.example"
            "api/simulados.php"
            "api/analise_questao_ia.php"
            "home.php"
            "login.php"
          )

          for file in "${CRITICAL_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              MISSING_FILES+=("$file")
              echo "‚ùå Arquivo cr√≠tico ausente: $file"
            fi
          done

          if [ ${#MISSING_FILES[@]} -gt 0 ]; then
            echo "‚ùå Deploy cancelado! ${#MISSING_FILES[@]} arquivo(s) cr√≠tico(s) ausente(s)."
            exit 1
          fi
          echo "‚úÖ Todos os arquivos cr√≠ticos presentes"

      - name: Testar auto-instala√ß√£o
        run: |
          echo "üîç Testando sistema de auto-instala√ß√£o..."

          # Verificar se auto_install.php n√£o tem erros de sintaxe
          php -l includes/auto_install.php

          # Criar diret√≥rio tempor√°rio para teste
          mkdir -p /tmp/test-install
          cd /tmp/test-install

          # Copiar arquivos necess√°rios
          cp -r $GITHUB_WORKSPACE/includes .
          cp -r $GITHUB_WORKSPACE/config .

          # Testar se database.php.example pode ser copiado
          if [ -f "config/database.php.example" ]; then
            cp config/database.php.example config/database.php
            echo "‚úÖ Arquivo de configura√ß√£o exemplo OK"
          else
            echo "‚ùå Arquivo database.php.example n√£o encontrado!"
            exit 1
          fi

          echo "‚úÖ Sistema de auto-instala√ß√£o validado"

      - name: Verificar configura√ß√µes de IA
        run: |
          echo "üîç Verificando configura√ß√µes de IA..."

          # Verificar se AIHelper est√° bem formado
          if grep -q "class AIHelper" includes/ai_helper.php; then
            echo "‚úÖ Classe AIHelper encontrada"
          else
            echo "‚ùå Classe AIHelper n√£o encontrada!"
            exit 1
          fi

          # Verificar providers suportados
          if grep -q "gemini" includes/ai_helper.php && \
             grep -q "openai" includes/ai_helper.php && \
             grep -q "groq" includes/ai_helper.php; then
            echo "‚úÖ Todos os providers de IA configurados"
          else
            echo "‚ö†Ô∏è Alguns providers de IA podem estar faltando"
          fi

      - name: Validar estrutura de API
        run: |
          echo "üîç Validando estrutura de API..."
          API_ERRORS=0

          # Verificar se APIs t√™m Content-Type JSON
          for api_file in api/*.php; do
            if [ -f "$api_file" ]; then
              if ! grep -q "Content-Type.*json" "$api_file"; then
                echo "‚ö†Ô∏è $api_file pode n√£o ter Content-Type JSON"
                API_ERRORS=$((API_ERRORS + 1))
              fi
            fi
          done

          # Verificar se APIs usam auth
          for api_file in api/*.php; do
            if [ -f "$api_file" ]; then
              if ! grep -q "require.*auth.php\|requireLogin\|requireAdmin" "$api_file"; then
                echo "‚ö†Ô∏è $api_file pode n√£o ter autentica√ß√£o"
                API_ERRORS=$((API_ERRORS + 1))
              fi
            fi
          done

          if [ $API_ERRORS -gt 0 ]; then
            echo "‚ö†Ô∏è $API_ERRORS aviso(s) em arquivos de API (n√£o bloqueante)"
          else
            echo "‚úÖ Estrutura de API validada"
          fi

      - name: Verificar seguran√ßa b√°sica
        run: |
          echo "üîç Verificando seguran√ßa b√°sica..."
          SECURITY_ISSUES=0

          # Verificar se h√° credenciais hardcoded (padr√µes comuns)
          if grep -r "password.*=.*['\"].*['\"]" --include="*.php" . | grep -v "password_hash\|password_verify\|'password'\|\"password\"" | grep -v ".example" | grep -v ".git"; then
            echo "‚ö†Ô∏è Poss√≠veis credenciais hardcoded encontradas"
            SECURITY_ISSUES=$((SECURITY_ISSUES + 1))
          fi

          # Verificar uso de prepared statements vs concatena√ß√£o SQL
          if grep -r "\$.*SELECT.*\$\|INSERT.*\$\|UPDATE.*\$\|DELETE.*\$" --include="*.php" api/ admin/ | grep -v "prepare\|execute\|query.*\?" | head -5; then
            echo "‚ö†Ô∏è Poss√≠vel concatena√ß√£o SQL encontrada (verificar prepared statements)"
            SECURITY_ISSUES=$((SECURITY_ISSUES + 1))
          fi

          # Verificar se arquivos sens√≠veis est√£o no .gitignore
          if [ -f ".gitignore" ]; then
            if ! grep -q "database.php" .gitignore || ! grep -q "estudos.db" .gitignore; then
              echo "‚ö†Ô∏è Arquivos sens√≠veis podem n√£o estar no .gitignore"
              SECURITY_ISSUES=$((SECURITY_ISSUES + 1))
            fi
          fi

          if [ $SECURITY_ISSUES -eq 0 ]; then
            echo "‚úÖ Verifica√ß√µes de seguran√ßa OK"
          else
            echo "‚ö†Ô∏è $SECURITY_ISSUES aviso(s) de seguran√ßa (n√£o bloqueante, revisar manualmente)"
          fi

      - name: Validar estrutura do banco de dados
        run: |
          echo "üîç Validando defini√ß√µes de banco de dados..."

          # Verificar se auto_install.php cont√©m todas as tabelas cr√≠ticas
          TABLES_REQUIRED=(
            "usuarios"
            "cursos"
            "modulos"
            "aulas"
            "simulados"
            "simulado_questoes"
            "simulado_tentativas"
            "configuracoes"
          )

          MISSING_TABLES=0
          for table in "${TABLES_REQUIRED[@]}"; do
            if ! grep -q "CREATE TABLE.*$table" includes/auto_install.php; then
              echo "‚ùå Tabela '$table' n√£o encontrada em auto_install.php"
              MISSING_TABLES=$((MISSING_TABLES + 1))
            fi
          done

          if [ $MISSING_TABLES -gt 0 ]; then
            echo "‚ùå $MISSING_TABLES tabela(s) cr√≠tica(s) ausente(s)!"
            exit 1
          fi

          echo "‚úÖ Estrutura de banco de dados validada"

      - name: Definir pasta de destino
        id: target
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "folder=/seleme.pt/" >> $GITHUB_OUTPUT
            echo "environment=Produ√ß√£o" >> $GITHUB_OUTPUT
            echo "color=green" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            echo "folder=/dev.seleme.pt" >> $GITHUB_OUTPUT
            echo "environment=Desenvolvimento" >> $GITHUB_OUTPUT
            echo "color=yellow" >> $GITHUB_OUTPUT
          fi

      - name: Exibir informa√ß√µes do deploy
        run: |
          echo "üöÄ ================================"
          echo "üöÄ Deploy para ${{ steps.target.outputs.environment }}"
          echo "üöÄ ================================"
          echo "üìÅ Pasta destino: ${{ steps.target.outputs.folder }}"
          echo "üåø Branch: ${{ github.ref_name }}"
          echo "üìù Commit: ${{ github.sha }}"
          echo "üë§ Autor: ${{ github.actor }}"

      - name: Gerar informa√ß√µes de deploy
        run: |
          # Criar version.json na raiz (ser√° enviado ao servidor)
          cat > version.json <<EOF
          {
            "version": "$(date +%Y.%m.%d-%H%M%S)",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "deployed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "deployed_by": "${{ github.actor }}",
            "environment": "${{ steps.target.outputs.environment }}"
          }
          EOF

          # Criar pasta deploy-info para logs (n√£o ser√° enviada)
          mkdir -p deploy-info
          cp version.json deploy-info/version.json

          cat > deploy-info/LAST_DEPLOY.txt <<EOF
          ====================================
          √öLTIMO DEPLOY
          ====================================
          Ambiente: ${{ steps.target.outputs.environment }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Data: $(date)
          Por: ${{ github.actor }}
          ====================================
          EOF

          echo "‚úÖ Arquivo de vers√£o criado"
          cat version.json

      - name: Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          server-dir: ${{ steps.target.outputs.folder }}/
          dangerous-clean-slate: false
          dry-run: false
          log-level: verbose
          state-name: .ftp-deploy-sync-state-${{ github.ref_name }}.json
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/vendor/**
            **/.env
            **/config/estudos.db
            **/config/database.php
            **/config/openai.php
            **/.github/**
            **/tests/**
            **/*.md
            **/.gitignore
            **/deploy-info/**

      - name: Resumo do Deploy
        if: success()
        run: |
          echo "‚úÖ ================================"
          echo "‚úÖ Deploy conclu√≠do com sucesso!"
          echo "‚úÖ ================================"
          echo ""
          echo "üìä Detalhes do Deploy:"
          echo "  ‚Ä¢ Ambiente: ${{ steps.target.outputs.environment }}"
          echo "  ‚Ä¢ Pasta: ${{ steps.target.outputs.folder }}"
          echo "  ‚Ä¢ Branch: ${{ github.ref_name }}"
          echo "  ‚Ä¢ Commit: $(git log -1 --pretty=format:'%h - %s')"
          echo "  ‚Ä¢ Arquivos enviados: ‚úì"
          echo ""
          echo "üß™ Testes Executados:"
          echo "  ‚úì Valida√ß√£o de sintaxe PHP"
          echo "  ‚úì Verifica√ß√£o de arquivos cr√≠ticos"
          echo "  ‚úì Teste de auto-instala√ß√£o"
          echo "  ‚úì Configura√ß√µes de IA"
          echo "  ‚úì Estrutura de API"
          echo "  ‚úì Verifica√ß√µes de seguran√ßa"
          echo "  ‚úì Valida√ß√£o de banco de dados"
          echo ""
          echo "üåê Acesse:"
          if [ "${{ steps.target.outputs.environment }}" == "Produ√ß√£o" ]; then
            echo "  ‚Ä¢ https://seleme.pt"
          else
            echo "  ‚Ä¢ https://dev.seleme.pt"
          fi

      - name: Notificar erro
        if: failure()
        run: |
          echo "‚ùå ================================"
          echo "‚ùå Deploy falhou!"
          echo "‚ùå ================================"
          echo ""
          echo "üîç Verifique os logs acima para detalhes do erro."
          echo ""
          echo "Poss√≠veis causas:"
          echo "  ‚Ä¢ ‚ùå Erro de sintaxe PHP"
          echo "  ‚Ä¢ ‚ùå Arquivo cr√≠tico ausente"
          echo "  ‚Ä¢ ‚ùå Falha no teste de auto-instala√ß√£o"
          echo "  ‚Ä¢ ‚ùå Configura√ß√£o de IA incorreta"
          echo "  ‚Ä¢ ‚ùå Estrutura de API inv√°lida"
          echo "  ‚Ä¢ ‚ùå Problema de seguran√ßa detectado"
          echo "  ‚Ä¢ ‚ùå Tabela de banco de dados ausente"
          echo "  ‚Ä¢ ‚ùå Credenciais FTP incorretas"
          echo "  ‚Ä¢ ‚ùå Servidor FTP offline"
          echo ""
          echo "üí° Dicas:"
          echo "  ‚Ä¢ Revise o log do teste que falhou"
          echo "  ‚Ä¢ Execute os testes localmente antes do push"
          echo "  ‚Ä¢ Verifique se todos os arquivos foram commitados"
