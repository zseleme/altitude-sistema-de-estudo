name: ValidaÃ§Ã£o de Pull Request

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  validate-pr:
    name: Validar Pull Request
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verificar tÃ­tulo do PR
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "TÃ­tulo do PR: $PR_TITLE"

          # Verificar se o tÃ­tulo Ã© descritivo (mÃ­nimo 10 caracteres)
          if [ ${#PR_TITLE} -lt 10 ]; then
            echo "âŒ TÃ­tulo do PR muito curto! Use um tÃ­tulo descritivo (mÃ­nimo 10 caracteres)"
            exit 1
          fi

          echo "âœ… TÃ­tulo do PR Ã© descritivo"

      - name: Verificar tamanho do PR
        run: |
          FILES_CHANGED=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | wc -l)
          LINES_ADDED=$(git diff --numstat origin/${{ github.event.pull_request.base.ref }}...HEAD | awk '{sum+=$1} END {print sum}')
          LINES_DELETED=$(git diff --numstat origin/${{ github.event.pull_request.base.ref }}...HEAD | awk '{sum+=$2} END {print sum}')

          echo "ğŸ“Š EstatÃ­sticas do PR:"
          echo "  Arquivos modificados: $FILES_CHANGED"
          echo "  Linhas adicionadas: $LINES_ADDED"
          echo "  Linhas removidas: $LINES_DELETED"

          # Avisar se o PR for muito grande
          if [ $FILES_CHANGED -gt 50 ]; then
            echo "âš ï¸  AVISO: PR muito grande ($FILES_CHANGED arquivos). Considere dividir em PRs menores."
          fi

          if [ $LINES_ADDED -gt 1000 ]; then
            echo "âš ï¸  AVISO: Muitas linhas adicionadas ($LINES_ADDED). Considere dividir em PRs menores."
          fi

      - name: Verificar arquivos modificados
        run: |
          echo "ğŸ“ Arquivos modificados neste PR:"
          git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD

          # Verificar se arquivos sensÃ­veis foram modificados
          SENSITIVE_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | grep -E "(config/database\.php|config/openai\.php|\.env)" || true)

          if [ ! -z "$SENSITIVE_FILES" ]; then
            echo "âš ï¸  AVISO: Arquivos sensÃ­veis modificados!"
            echo "$SENSITIVE_FILES"
            echo "Certifique-se de nÃ£o commitar credenciais!"
          fi

      - name: Verificar commits
        run: |
          COMMITS=$(git log --oneline origin/${{ github.event.pull_request.base.ref }}...HEAD)
          COMMIT_COUNT=$(echo "$COMMITS" | wc -l)

          echo "ğŸ“ Commits neste PR ($COMMIT_COUNT):"
          echo "$COMMITS"

          # Verificar mensagens de commit
          BAD_COMMITS=$(git log --format=%s origin/${{ github.event.pull_request.base.ref }}...HEAD | grep -iE "^(wip|test|fix|update)$" || true)

          if [ ! -z "$BAD_COMMITS" ]; then
            echo "âš ï¸  AVISO: Commits com mensagens pouco descritivas encontrados:"
            echo "$BAD_COMMITS"
            echo "Considere usar mensagens mais descritivas!"
          fi

  auto-label:
    name: Adicionar Labels AutomÃ¡ticas
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detectar tipo de mudanÃ§as
        id: detect
        run: |
          FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD)

          # Detectar tipo de arquivos modificados
          if echo "$FILES" | grep -q "^admin/"; then
            echo "admin=true" >> $GITHUB_OUTPUT
          fi

          if echo "$FILES" | grep -q "^api/"; then
            echo "api=true" >> $GITHUB_OUTPUT
          fi

          if echo "$FILES" | grep -q "^includes/"; then
            echo "core=true" >> $GITHUB_OUTPUT
          fi

          if echo "$FILES" | grep -q "^migrations/"; then
            echo "database=true" >> $GITHUB_OUTPUT
          fi

          if echo "$FILES" | grep -q "\.md$"; then
            echo "documentation=true" >> $GITHUB_OUTPUT
          fi

          if echo "$FILES" | grep -q "^\.github/"; then
            echo "ci=true" >> $GITHUB_OUTPUT
          fi

          # Detectar tamanho do PR
          LINES=$(git diff --numstat origin/${{ github.event.pull_request.base.ref }}...HEAD | awk '{sum+=$1+$2} END {print sum}')
          if [ $LINES -lt 100 ]; then
            echo "size=small" >> $GITHUB_OUTPUT
          elif [ $LINES -lt 500 ]; then
            echo "size=medium" >> $GITHUB_OUTPUT
          else
            echo "size=large" >> $GITHUB_OUTPUT
          fi

      - name: Adicionar label - Admin
        if: steps.detect.outputs.admin == 'true'
        uses: actions-ecosystem/action-add-labels@v1
        with:
          labels: 'area: admin'

      - name: Adicionar label - API
        if: steps.detect.outputs.api == 'true'
        uses: actions-ecosystem/action-add-labels@v1
        with:
          labels: 'area: api'

      - name: Adicionar label - Core
        if: steps.detect.outputs.core == 'true'
        uses: actions-ecosystem/action-add-labels@v1
        with:
          labels: 'area: core'

      - name: Adicionar label - Database
        if: steps.detect.outputs.database == 'true'
        uses: actions-ecosystem/action-add-labels@v1
        with:
          labels: 'area: database'

      - name: Adicionar label - Documentation
        if: steps.detect.outputs.documentation == 'true'
        uses: actions-ecosystem/action-add-labels@v1
        with:
          labels: 'documentation'

      - name: Adicionar label - CI/CD
        if: steps.detect.outputs.ci == 'true'
        uses: actions-ecosystem/action-add-labels@v1
        with:
          labels: 'ci/cd'

      - name: Adicionar label - Tamanho
        uses: actions-ecosystem/action-add-labels@v1
        with:
          labels: 'size: ${{ steps.detect.outputs.size }}'

  pr-comment:
    name: Comentar no PR
    runs-on: ubuntu-latest
    needs: validate-pr
    permissions:
      pull-requests: write

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gerar estatÃ­sticas
        id: stats
        run: |
          FILES_CHANGED=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | wc -l)
          LINES_ADDED=$(git diff --numstat origin/${{ github.event.pull_request.base.ref }}...HEAD | awk '{sum+=$1} END {print sum}')
          LINES_DELETED=$(git diff --numstat origin/${{ github.event.pull_request.base.ref }}...HEAD | awk '{sum+=$2} END {print sum}')
          COMMITS=$(git log --oneline origin/${{ github.event.pull_request.base.ref }}...HEAD | wc -l)

          echo "files=$FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "added=$LINES_ADDED" >> $GITHUB_OUTPUT
          echo "deleted=$LINES_DELETED" >> $GITHUB_OUTPUT
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT

      - name: Comentar estatÃ­sticas
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ğŸ“Š EstatÃ­sticas do Pull Request

            | MÃ©trica | Valor |
            |---------|-------|
            | ğŸ“ Arquivos modificados | ${{ steps.stats.outputs.files }} |
            | â• Linhas adicionadas | ${{ steps.stats.outputs.added }} |
            | â– Linhas removidas | ${{ steps.stats.outputs.deleted }} |
            | ğŸ“ Commits | ${{ steps.stats.outputs.commits }} |

            ### âœ… ValidaÃ§Ãµes
            - [x] Sintaxe PHP verificada
            - [x] TÃ­tulo descritivo
            - [x] Tamanho do PR analisado

            ---
            *ComentÃ¡rio gerado automaticamente pelo GitHub Actions*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
