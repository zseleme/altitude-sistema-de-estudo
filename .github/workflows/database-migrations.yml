name: Verificar Migra√ß√µes de Banco

on:
  pull_request:
    paths:
      - 'migrations/**'
  push:
    branches: [main]
    paths:
      - 'migrations/**'

jobs:
  validate-migrations:
    name: Validar Migra√ß√µes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: pdo, pdo_sqlite, pdo_pgsql, mbstring

      - name: Listar migra√ß√µes
        run: |
          echo "üìã Migra√ß√µes encontradas:"
          ls -la migrations/*.php 2>/dev/null || echo "Nenhuma migra√ß√£o encontrada"

      - name: Verificar sintaxe das migra√ß√µes
        run: |
          echo "üîç Verificando sintaxe das migra√ß√µes..."
          for file in migrations/*.php; do
            if [ -f "$file" ]; then
              echo "Verificando: $file"
              php -l "$file"
            fi
          done
          echo "‚úÖ Todas as migra√ß√µes t√™m sintaxe v√°lida"

      - name: Testar migra√ß√µes no SQLite
        run: |
          echo "üß™ Testando migra√ß√µes no SQLite..."

          # Criar banco de dados tempor√°rio
          php -r "require_once 'includes/auto_install.php';"

          if [ ! -f "config/estudos.db" ]; then
            echo "‚ùå Falha ao criar banco de teste"
            exit 1
          fi

          echo "‚úÖ Banco de dados de teste criado"

          # Executar cada migra√ß√£o
          for migration in migrations/*.php; do
            if [ -f "$migration" ]; then
              echo "Executando: $migration"
              php "$migration" || {
                echo "‚ùå Falha ao executar: $migration"
                exit 1
              }
            fi
          done

          echo "‚úÖ Todas as migra√ß√µes executadas com sucesso"

      - name: Verificar estrutura do banco ap√≥s migra√ß√µes
        run: |
          echo "üìä Verificando estrutura do banco..."

          php -r "
            if (!file_exists('config/estudos.db')) {
              echo '‚ùå Banco de dados n√£o encontrado' . PHP_EOL;
              exit(1);
            }

            \$db = new PDO('sqlite:config/estudos.db');
            \$tables = \$db->query(\"SELECT name FROM sqlite_master WHERE type='table' ORDER BY name\")->fetchAll(PDO::FETCH_COLUMN);

            echo 'üìã Tabelas no banco (' . count(\$tables) . '):' . PHP_EOL;
            foreach (\$tables as \$table) {
              // Contar registros
              \$count = \$db->query(\"SELECT COUNT(*) FROM {\$table}\")->fetchColumn();
              echo '  ‚úì ' . str_pad(\$table, 30) . ' (' . \$count . ' registros)' . PHP_EOL;
            }

            echo PHP_EOL . '‚úÖ Estrutura do banco validada' . PHP_EOL;
          "

      - name: Verificar integridade referencial
        run: |
          echo "üîó Verificando integridade referencial..."

          php -r "
            \$db = new PDO('sqlite:config/estudos.db');
            \$db->exec('PRAGMA foreign_keys = ON');

            // Tentar algumas opera√ß√µes para verificar FKs
            try {
              // Teste: inserir aula sem curso (deve falhar)
              \$db->exec(\"INSERT INTO aulas (titulo, descricao, curso_id) VALUES ('Test', 'Test', 99999)\");
              echo '‚ùå FK n√£o est√° funcionando!' . PHP_EOL;
              exit(1);
            } catch (PDOException \$e) {
              echo '‚úÖ Foreign Keys funcionando corretamente' . PHP_EOL;
            }
          "

  check-migration-order:
    name: Verificar Ordem das Migra√ß√µes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verificar novas migra√ß√µes
        run: |
          echo "üîç Verificando novas migra√ß√µes adicionadas..."

          # Listar migra√ß√µes no PR/commit
          NEW_MIGRATIONS=$(git diff --name-only origin/main...HEAD | grep "^migrations/" || true)

          if [ -z "$NEW_MIGRATIONS" ]; then
            echo "‚ÑπÔ∏è  Nenhuma nova migra√ß√£o adicionada"
            exit 0
          fi

          echo "üìù Novas migra√ß√µes:"
          echo "$NEW_MIGRATIONS"

          # Verificar nomenclatura
          for migration in $NEW_MIGRATIONS; do
            filename=$(basename "$migration")
            if [[ ! $filename =~ ^add_.*\.php$ ]] && [[ ! $filename =~ ^create_.*\.php$ ]] && [[ ! $filename =~ ^update_.*\.php$ ]]; then
              echo "‚ö†Ô∏è  AVISO: Nome da migra√ß√£o pode n√£o seguir conven√ß√£o: $filename"
              echo "   Sugest√£o: use prefixos como add_, create_, update_"
            fi
          done

          echo "‚úÖ Verifica√ß√£o de nomenclatura conclu√≠da"

  comment-migration-info:
    name: Comentar Informa√ß√µes das Migra√ß√µes
    runs-on: ubuntu-latest
    needs: [validate-migrations, check-migration-order]
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gerar resumo das migra√ß√µes
        id: summary
        run: |
          NEW_MIGRATIONS=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | grep "^migrations/" || echo "")

          if [ -z "$NEW_MIGRATIONS" ]; then
            echo "has_migrations=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "has_migrations=true" >> $GITHUB_OUTPUT

          MIGRATION_LIST=""
          for migration in $NEW_MIGRATIONS; do
            MIGRATION_LIST="${MIGRATION_LIST}- \`${migration}\`\n"
          done

          echo "migrations<<EOF" >> $GITHUB_OUTPUT
          echo -e "$MIGRATION_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comentar no PR
        if: steps.summary.outputs.has_migrations == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## üóÑÔ∏è Migra√ß√µes de Banco de Dados

            Este PR adiciona ou modifica migra√ß√µes de banco de dados:

            ${{ steps.summary.outputs.migrations }}

            ### ‚ö†Ô∏è A√ß√µes Necess√°rias Ap√≥s o Merge:

            1. **Para ambiente de desenvolvimento:**
               \`\`\`bash
               # Execute as novas migra√ß√µes
               php migrations/nome_da_migracao.php
               \`\`\`

            2. **Para ambiente de produ√ß√£o:**
               - [ ] Fazer backup do banco de dados antes de executar
               - [ ] Executar as migra√ß√µes no servidor de produ√ß√£o
               - [ ] Verificar se n√£o h√° erros
               - [ ] Testar funcionalidades afetadas

            ### ‚úÖ Valida√ß√µes Executadas:
            - [x] Sintaxe PHP das migra√ß√µes
            - [x] Execu√ß√£o em banco SQLite de teste
            - [x] Verifica√ß√£o de integridade referencial
            - [x] Nomenclatura das migra√ß√µes

            ---
            *Coment√°rio gerado automaticamente pelo GitHub Actions*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  postgres-compatibility:
    name: Verificar Compatibilidade PostgreSQL
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: pdo, pdo_pgsql, mbstring

      - name: Testar conex√£o PostgreSQL
        run: |
          echo "üêò Testando conex√£o com PostgreSQL..."
          php -r "
            try {
              \$pdo = new PDO('pgsql:host=localhost;port=5432;dbname=test_db', 'postgres', 'postgres');
              echo '‚úÖ Conex√£o com PostgreSQL OK' . PHP_EOL;
            } catch (Exception \$e) {
              echo '‚ùå Erro ao conectar: ' . \$e->getMessage() . PHP_EOL;
              exit(1);
            }
          "

      - name: Verificar migra√ß√µes no PostgreSQL
        run: |
          echo "üß™ Verificando compatibilidade das migra√ß√µes com PostgreSQL..."

          # Criar schema
          php -r "
            \$pdo = new PDO('pgsql:host=localhost;port=5432;dbname=test_db', 'postgres', 'postgres');
            \$pdo->exec('CREATE SCHEMA IF NOT EXISTS estudos');
            \$pdo->exec('SET search_path TO estudos');
            echo '‚úÖ Schema criado' . PHP_EOL;
          "

          echo "‚ÑπÔ∏è  Verifica√ß√£o de compatibilidade PostgreSQL conclu√≠da"
          echo "üí° Execute setup_postgres.php para criar tabelas completas"
