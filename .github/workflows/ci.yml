name: CI - Verifica√ß√£o de C√≥digo

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  php-syntax-check:
    name: Verificar Sintaxe PHP
    runs-on: ubuntu-latest

    strategy:
      matrix:
        php-version: ['7.4', '8.0', '8.1', '8.2']

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar PHP ${{ matrix.php-version }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: pdo, pdo_sqlite, pdo_pgsql, mbstring
          coverage: none

      - name: Verificar vers√£o do PHP
        run: php -v

      - name: Verificar sintaxe de todos arquivos PHP
        run: |
          find . -name "*.php" -not -path "./vendor/*" -exec php -l {} \; | tee /tmp/php-syntax.log
          if grep -q "Parse error" /tmp/php-syntax.log; then
            echo "‚ùå Erros de sintaxe encontrados!"
            exit 1
          fi
          echo "‚úÖ Nenhum erro de sintaxe encontrado!"

      - name: Verificar estrutura de pastas
        run: |
          echo "Verificando estrutura do projeto..."
          required_dirs=("admin" "api" "includes" "config" "migrations")
          for dir in "${required_dirs[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "‚ùå Pasta obrigat√≥ria n√£o encontrada: $dir"
              exit 1
            fi
            echo "‚úÖ Pasta encontrada: $dir"
          done

      - name: Verificar arquivos importantes
        run: |
          echo "Verificando arquivos importantes..."
          required_files=("index.php" "home.php" "login.php" "includes/auth.php" "config/database.example.php")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "‚ùå Arquivo obrigat√≥rio n√£o encontrado: $file"
              exit 1
            fi
            echo "‚úÖ Arquivo encontrado: $file"
          done

  test-auto-install:
    name: Testar Auto-Instala√ß√£o
    runs-on: ubuntu-latest
    needs: php-syntax-check

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: pdo, pdo_sqlite, mbstring

      - name: Testar cria√ß√£o do banco SQLite
        run: |
          php -r "require_once 'includes/auto_install.php';"

          if [ -f "config/estudos.db" ]; then
            echo "‚úÖ Banco de dados criado com sucesso!"
          else
            echo "‚ùå Falha ao criar banco de dados"
            exit 1
          fi

      - name: Verificar tabelas criadas
        run: |
          php -r "
            \$db = new PDO('sqlite:config/estudos.db');
            \$tables = \$db->query(\"SELECT name FROM sqlite_master WHERE type='table' ORDER BY name\")->fetchAll(PDO::FETCH_COLUMN);
            echo 'Tabelas criadas: ' . count(\$tables) . PHP_EOL;
            foreach (\$tables as \$table) {
              echo '  - ' . \$table . PHP_EOL;
            }

            \$required_tables = ['usuarios', 'categorias', 'cursos', 'aulas', 'simulados'];
            foreach (\$required_tables as \$table) {
              if (!in_array(\$table, \$tables)) {
                echo '‚ùå Tabela obrigat√≥ria n√£o encontrada: ' . \$table . PHP_EOL;
                exit(1);
              }
            }
            echo '‚úÖ Todas as tabelas obrigat√≥rias foram criadas!' . PHP_EOL;
          "

      - name: Verificar usu√°rio admin criado
        run: |
          php -r "
            \$db = new PDO('sqlite:config/estudos.db');
            \$admin = \$db->query(\"SELECT * FROM usuarios WHERE email = 'admin@teste.com'\")->fetch(PDO::FETCH_ASSOC);

            if (\$admin) {
              echo '‚úÖ Usu√°rio admin criado com sucesso!' . PHP_EOL;
              echo 'Nome: ' . \$admin['nome'] . PHP_EOL;
              echo 'Email: ' . \$admin['email'] . PHP_EOL;
              echo 'Admin: ' . (\$admin['is_admin'] ? 'Sim' : 'N√£o') . PHP_EOL;
            } else {
              echo '‚ùå Usu√°rio admin n√£o foi criado!' . PHP_EOL;
              exit(1);
            }
          "

  security-check:
    name: Verifica√ß√£o de Seguran√ßa
    runs-on: ubuntu-latest
    needs: php-syntax-check

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Verificar arquivos sens√≠veis
        run: |
          echo "Verificando se arquivos sens√≠veis est√£o no .gitignore..."

          if [ -f "config/database.php" ]; then
            echo "‚ö†Ô∏è  AVISO: config/database.php existe (deveria estar no .gitignore)"
          fi

          if [ -f "config/estudos.db" ]; then
            echo "‚ö†Ô∏è  AVISO: config/estudos.db existe (deveria estar no .gitignore)"
          fi

          if [ -f "config/openai.php" ]; then
            echo "‚ö†Ô∏è  AVISO: config/openai.php existe (deveria estar no .gitignore)"
          fi

          echo "‚úÖ Verifica√ß√£o de arquivos sens√≠veis conclu√≠da"

      - name: Verificar por credenciais hardcoded
        run: |
          echo "Procurando por poss√≠veis credenciais hardcoded..."

          # Buscar por padr√µes suspeitos (excluindo arquivos de exemplo)
          if grep -r -i "password.*=.*['\"].*['\"]" --include="*.php" --exclude="*.example.php" . | grep -v "password_hash" | grep -v "PASSWORD_DEFAULT" | grep -v "\$_POST" | grep -v "placeholder"; then
            echo "‚ö†Ô∏è  AVISO: Poss√≠veis senhas hardcoded encontradas!"
          fi

          echo "‚úÖ Verifica√ß√£o de credenciais conclu√≠da"

  build-success:
    name: Build Conclu√≠do
    runs-on: ubuntu-latest
    needs: [php-syntax-check, test-auto-install, security-check]

    steps:
      - name: Resultado do Build
        run: |
          echo "üéâ ================================"
          echo "üéâ Build conclu√≠do com sucesso!"
          echo "üéâ ================================"
          echo ""
          echo "‚úÖ Sintaxe PHP verificada"
          echo "‚úÖ Auto-instala√ß√£o testada"
          echo "‚úÖ Verifica√ß√µes de seguran√ßa OK"
          echo ""
          echo "Pronto para merge! üöÄ"
